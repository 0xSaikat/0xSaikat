name: Daily Cybersecurity Quote Update
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  quote-updater:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Load Sanitized Quotes
        id: quotes
        run: |
          # Properly escaped quotes with security sanitization
          CYBER_QUOTES=(
            "ðŸ”“ The only secure system is one that's powered off, encased in concrete, and guarded."
            "ðŸ›¡ï¸ Security: Expensive until you need it desperately."
            "ðŸ’» Hacking: The art of finding truth in systems."
            "ðŸŽ¯ If you think technology can solve security problems, you don't understand either."
            "ðŸ”‘ Passwords are like jokes: longer and more obscure = better."
            "ðŸŒ In cyberspace, the First Amendment is a local ordinance."
            "â™‚ï¸ A good hacker learns; a great hacker teaches."
            "ðŸš¨ Two company types: hacked and don't-know-they're-hacked."
            "ðŸ’¡ Innovation separates leaders from followers."
            "âš¡ Cybersecurity: journey, not destination."
          )
          # Secure random selection
          SELECTED_QUOTE="${CYBER_QUOTES[$(( RANDOM % ${#CYBER_QUOTES[@]} ))]}"
          
          # Sanitize output using printf for special characters
          printf -v SAFE_QUOTE "%q" "${SELECTED_QUOTE}"
          echo "quote=${SAFE_QUOTE}" >> $GITHUB_OUTPUT

      - name: Inject Quote Safely
        run: |
          # Use parameter expansion with backslash escapes
          CLEAN_QUOTE=$(echo '${{ steps.quotes.outputs.quote }}' | \
            sed -e 's/[\/&|]/\\&/g' \
                -e "s/'/\\\\'/g" \
                -e 's/`/\\\\`/g')
          
          # Atomic write with temporary file
          awk -v q="${CLEAN_QUOTE}" '
            /<p id="random-quote"/ {
              print $0
              print "    " q
              flag=1
              next
            }
            flag && /<\/p>/ { flag=0 }
            !flag
          ' README.md > tmp.md && mv tmp.md README.md

      - name: Secure Commit
        run: |
          git config --global user.name "Quote Guardian"
          git config --global user.email "security-bot@users.noreply.github.com"
          git add README.md
          git diff --quiet || (git commit -m "ðŸ”„ Daily Wisdom: $(date +'%Y-%m-%d')" && git push)
